
---
title: python-graphviz图数据可视化入门
date: 2018-09-25 20:17:55
tags: [graphviz]
toc: true
xiongzhang: false

---
<span></span>
<!-- more -->


本文代码运行环境:

- windows10
- python3.6
- jupyter notebook

### 安装 

graphviz为Graphviz图形绘制软件提供了一个简单的纯Python接口。它在Python 2.7和3.4+下运行。要使用pip安装它，请运行以下命令：

```
pip install graphviz
```

### 依赖

graphviz有一个同名依赖`graphviz`, 这是一个c开发的软件包, 可以通过命令行调用。它的安装很简单, 如果在windows下, 只需要下载二进制包进行安装即可, 具体过程参考这篇文章的[安装Graphviz](http://mlln.cn/2018/09/21/pydotplus%E5%AE%89%E8%A3%85%E5%92%8C%E5%9F%BA%E6%9C%AC%E5%85%A5%E9%97%A8/#%E5%AE%89%E8%A3%85Graphviz)部分。

### 基本用法


graphviz模块提供两个类：`Graph`和`Digraph`。他们使用DOT语言为无向和有向图创建图形描述。他们有相同的API。

通过实例化新的Graph或Digraph对象来创建图形：


```python
from graphviz import Digraph
dot = Digraph(comment='这是一个有向图')
str(dot)
```




{% raw %}
<div class="output">
输出(plain):<br/>

    '// 这是一个有向图\ndigraph {\n}'

</div>
{% endraw %}



它们的构造函数允许设置图形的`name`，DOT代码的`filename`，源代码行的注释等。

使用`node（）`和`edge（）`或`edges（）`方法将节点和边添加到图形对象：

- `node()`方法第一个参数是name, 第二个参数是label
- `edges()`方法可以一次添加多个边, 每个边用字符串表示, 比如`AB`表示从A到B的边
- `edge()`方法一次添加一个边


```python
dot = Digraph(comment='这是一个有向图')
dot.node('A', '作者')
dot.node('B', '医生')
dot.node('C', '律师')

dot.edges(['AB', 'AC'])
dot.edge('B', 'C')
print(dot.source)
```

{% raw %}
<div class="output">
输出(stream):<br>
    // 这是一个有向图
    <br />digraph {
    <br />	A [label="作者"]
    <br />	B [label="医生"]
    <br />	C [label="律师"]
    <br />	A -> B
    <br />	A -> C
    <br />	B -> C
    <br />}
    <br />
</div>
{% endraw %}

使用`render`方法将保存dot源码, 并且会渲染图形, 使用`view=True`参数可以自动打开应用程序以便浏览生成的图:


```python
# 将dot源码保存到文件:output-graph.gv
# 同时会生成一个pdf文件: output-graph.gv.pdf
dot.render('output-graph.gv', view=True)
```




{% raw %}
<div class="output">
输出(plain):<br/>

    'output-graph.gv.pdf'

</div>
{% endraw %}



除了PDF, 还可以生成其他格式, 比如png:


```python
dot.format = 'png'
dot.render('output-graph.gv', view=True)
```




{% raw %}
<div class="output">
输出(plain):<br/>

    'output-graph.gv.png'

</div>
{% endraw %}



由于这是jupyter notebook环境, 我们直接使用notebook展示生成的图片即可:


```python
from IPython.display import display, Image
Image(dot.render('output-graph.gv'))
```




![png](output_12_0.png)



### 字体乱码

我们可以看到中文的label无法正确显示在图中, 因为默认的字体并不支持中文, 需要我们为node设置字体, 比如我们设置成黑体:


```python
dot = Digraph(comment='这是一个有向图')
dot.node('A', '作者', fontname="Heiti")
dot.node('B', '医生')
dot.node('C', '律师')
dot.edges(['AB', 'AC'])
dot.edge('B', 'C')
dot.format = 'png'
Image(dot.render('output-graph-font.gv'))

```

{% raw %}
<div class="output">
输出(stream):<br>
    

    <br />(dot.exe:10280): Pango-WARNING **: couldn't load font "Heiti Not-Rotated 14", falling back to "Sans Not-Rotated 14", expect ugly output.

    <br />
</div>
{% endraw %}




![png](output_14_1.png)



### piped输出

为了直接获取Graphviz软件渲染结果, 而不是让它保存到文件中, 我们可以使用`pipe()`方法, 比如我们可以直接获取渲染后的svg源码:


```python
from graphviz import Graph
h = Graph('hello', format='svg')
h.edge('Hello', 'World')
print(h.pipe().decode('utf-8'))  
```

{% raw %}
<div class="output">
输出(stream):<br>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>

    <br /><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"

    <br /> "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

    <br /><!-- Generated by graphviz version 2.38.0 (20140413.2041)

    <br /> -->

    <br /><!-- Title: hello Pages: 1 -->

    <br /><svg width="77pt" height="116pt"

    <br /> viewBox="0.00 0.00 76.89 116.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">

    <br /><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 112)">

    <br /><title>hello</title>

    <br /><polygon fill="white" stroke="none" points="-4,4 -4,-112 72.8939,-112 72.8939,4 -4,4"/>

    <br /><!-- Hello -->

    <br /><g id="node1" class="node"><title>Hello</title>

    <br /><ellipse fill="none" stroke="black" cx="34.4469" cy="-90" rx="29.795" ry="18"/>

    <br /><text text-anchor="middle" x="34.4469" y="-86.3" font-family="Times New Roman,serif" font-size="14.00">Hello</text>

    <br /></g>

    <br /><!-- World -->

    <br /><g id="node2" class="node"><title>World</title>

    <br /><ellipse fill="none" stroke="black" cx="34.4469" cy="-18" rx="34.394" ry="18"/>

    <br /><text text-anchor="middle" x="34.4469" y="-14.3" font-family="Times New Roman,serif" font-size="14.00">World</text>

    <br /></g>

    <br /><!-- Hello&#45;&#45;World -->

    <br /><g id="edge1" class="edge"><title>Hello&#45;&#45;World</title>

    <br /><path fill="none" stroke="black" d="M34.4469,-71.6966C34.4469,-60.8463 34.4469,-46.9167 34.4469,-36.1043"/>

    <br /></g>

    <br /></g>

    <br /></svg>

    <br />
    <br />
</div>
{% endraw %}

### jupyter notebook中显示

因为Graph和Bigraph类都有`_repr_svg_()`方法, 因此他们可以直接显示在notebook中, 而不需要做任何处理, 例如, 上面的svg图, 可以直接显示:


```python
h
```




![svg](output_18_0.svg)



### 显示风格

使用`graph_attr`, `node_attr`, `edge_attr`参数, 你可以更改图中节点和边的显示样式:


```python
ps = Digraph(name='pet-shop', node_attr={'shape': 'plaintext'})
ps.node('parrot')
ps.node('dead')
ps.edge('parrot', 'dead')
ps
```




![svg](output_20_0.svg)



创建完毕以后, 你可以更改这些样式:


```python
ps.graph_attr['rankdir'] = 'LR'
ps.edge_attr.update(arrowhead='vee', arrowsize='2')
ps
```




![svg](output_22_0.svg)



### 属性

我们可以直接更改图中所有节点和边的属性, 相当于全局配置, 只要使用`attr`方法即可:


```python
ni = Graph('ni')
# 设置所有节点的形状
ni.attr('node', shape='rarrow')
ni.node('1', 'Ni!')
ni.node('2', 'Ni!')
# 如果单独设置, 优先级更高
ni.node('3', 'Ni!', shape='egg')
ni.node('4', 'Ni!')
ni
```




![svg](output_24_0.svg)



### 使用引号和HTML作为label

在label中使用引号需要使用转义字符`\`:


```python
ni.node('5', '\"Ni\"')
ni
```




![svg](output_26_0.svg)



在label中使用html可以使用`< >`将html内容括起来, 比如, 我们可以使用下标`sub`:


```python
ni.node('6', '<N<sub>i</sub>>')
ni
```




![svg](output_28_0.svg)



### 子图和集群

`Graph`和`Bigraph'对象都有`subgraph()`方法用于添加子图, 它有两种用法:

- 可以直接添加一个Graph或者Bigraph对象:


```python
p = Graph(name='parent')
p.edge('spam', 'eggs')

c = Graph(name='child', node_attr={'shape': 'box'})
c.edge('foo', 'bar')

p.subgraph(c)
p
```




![svg](output_30_0.svg)



- 使用`with`代码块:


```python
p = Graph(name='parent')
p.edge('spam', 'eggs')

with p.subgraph(name='child', node_attr={'shape': 'box'}) as c:
   c.edge('foo', 'bar')
p
```




![svg](output_32_0.svg)



### 引擎

渲染引擎可以选择多种, 而不仅仅是`dot`, 比如你可以使用`neato`:



```python
g = Graph(engine='neato')
```

或者也可以直接更改渲染引擎:


```python
g.engine = 'circo'
```

### 添加dot语句

有些应用场景是需要使用已经写好的dot语句的, 这时候我们可以直接调用`body.append`方法来追加dot语句:


```python
rt = Digraph()
rt.body.append('\t"King Arthur" -> {\n\t\t"Sir Bedevere", "Sir Lancelot"\n\t}')
rt.edge('Sir Bedevere', 'Sir Lancelot', constraint='false')
rt
```




![svg](output_38_0.svg)



### 使用dot文件和源码

我们可以直接使用`Source`类来直接实例化一个Source对象, 传入的参数就是dot源码, 然后可以调用render方法渲染成图片:


```python
from graphviz import Source
src = Source('digraph "the holy hand grenade" { rankdir=LR; 1 -> 2 -> 3 -> lob }')
str(src)
```




{% raw %}
<div class="output">
输出(plain):<br/>

    '<graphviz.files.Source object at 0x000002953EFFE908>'

</div>
{% endraw %}



我们还可以直接使用`from_file`方法来从一个dot文件实例化:


```python
src = Source.from_file('output-graph-font.gv')
src
```

{% raw %}
<div class="output">
输出(stream):<br>
    

    <br />(dot.exe:14100): Pango-WARNING **: couldn't load font "Heiti Not-Rotated 14", falling back to "Sans Not-Rotated 14", expect ugly output.

    <br />
</div>
{% endraw %}




![svg](output_42_1.svg)



> 统计咨询请加QQ 2726725926, 微信 shujufenxidaizuo,  SPSS统计咨询是收费的

很多时候我们要多次浏览绘制的图, 但是又不想保存这个文件, 那么我们可以使用临时文件保存生成的结果:


```python
import tempfile

g = Graph()
g.node('spam')

g.view(tempfile.mktemp('.gv'))  
```




{% raw %}
<div class="output">
输出(plain):<br/>

    'C:\\Users\\syd\\AppData\\Local\\Temp\\tmp48i7e5z2.gv.pdf'

</div>
{% endraw %}




> **注意**
> 本文由jupyter notebook转换而来, 您可以在这里下载[notebook](python-graphviz图数据可视化入门.ipynb)
> 有问题可以直接在下方留言
> 微博上@mlln-cn可以向我免费题问
> 请记住我的网址: mlln.cn 或者 jupyter.cn
